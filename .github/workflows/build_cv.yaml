name: Build CV and upload PDF

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Run every Sunday at midnight
  push:
    paths:
      - CV/*.tex

jobs:
  fetch_stars:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ["polanalyser", "structuredlight", "EasyPySpin"]

    steps:
      - uses: actions/checkout@v3
      - name: Check GitHub Stars and store them into files (named as CV/github_stars/$REPO.tex)
        env:
          REPO: ${{ matrix.repo }}
          OUT_DIR: CV/github_stars
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p "$OUT_DIR"
          out_file="$OUT_DIR/$REPO.tex"
          tmp_json="$(mktemp)"

          max_retries=3
          delay=5

          i=0
          while :; do
            i=$((i+1))

            http_status=$(curl -sS -w "%{http_code}" -o "$tmp_json" \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/elerac/$REPO")

            if [ "$http_status" != "200" ]; then
              echo "GitHub API returned HTTP $http_status for repo '$REPO'" >&2
            else
              stars="$(jq -r '.stargazers_count // empty' < "$tmp_json")" || {
                echo "Failed to parse stargazers_count with jq" >&2
                stars=""
              }

              if [ -n "$stars" ] && [[ "$stars" =~ ^[0-9]+$ ]]; then
                printf "%s\n" "$stars" > "$out_file"
                echo "Wrote stargazers_count=$stars to $out_file"
                rm -f "$tmp_json"
                exit 0
              else
                echo "Invalid or missing stargazers_count (got: '${stars:-<empty>}')" >&2
              fi
            fi

            if [ "$i" -ge "$max_retries" ]; then
              echo "Failed to fetch valid stargazers_count after $max_retries attempts." >&2

              if [ -f "$out_file" ]; then
                echo "Keeping existing $out_file as fallback." >&2
                rm -f "$tmp_json"
                exit 0
              fi

              rm -f "$tmp_json"
              exit 1
            fi

            echo "Retrying in ${delay}s (attempt $i/$max_retries)..." >&2
            sleep "$delay"
          done
      - name: Show the number of stars
        run: |
          cat CV/github_stars/${{matrix.repo}}.tex
      - name: Upload files
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_github_stars_${{ github.run_id }}_${{ matrix.repo }}
          path: CV/github_stars/${{ matrix.repo }}.tex

  check_stars:
    needs: fetch_stars
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download files
        uses: actions/download-artifact@v4
        with:
          path: CV/github_stars
          pattern: artifacts_github_stars_*
          merge-multiple: true
      - name: Show the number of stars 
        run: |
          for file in CV/github_stars/*.tex; do
            echo "File: $file"
            cat $file
          done
      - name: Check if the number of stars is changed
        id: check
        run: |
          if [ -n "$(git status CV/github_stars/*.tex --porcelain)" ]; then
            echo "There are some changes in CV/github_stars/*.tex files"
            echo "stars_updated=true" >> $GITHUB_OUTPUT
          else
            echo "There are no changes in CV/github_stars/*.tex files"
            echo "stars_updated=false" >> $GITHUB_OUTPUT
          fi
    outputs:
      stars_updated: ${{ steps.check.outputs.stars_updated }}

  build:
    needs: check_stars
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || needs.check_stars.outputs.stars_updated == 'true'
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v3
      - name: Download updated GitHub stars
        uses: actions/download-artifact@v4
        with:
          path: CV/github_stars
          pattern: artifacts_github_stars_*
          merge-multiple: true
      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          working_directory: CV
      - name: Rename PDF file
        run: |
          mv CV/main.pdf CV/cv_ryota_maeda.pdf
      - name: Upload PDF file
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_cv
          path: CV/cv_ryota_maeda.pdf

  push:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Set up
        uses: actions/checkout@v3

      - name: Download updated GitHub stars
        uses: actions/download-artifact@v4
        with:
          path: CV/github_stars
          pattern: artifacts_github_stars_*
          merge-multiple: true

      - name: Download PDF file
        uses: actions/download-artifact@v4
        with:
          name: artifacts_cv
          path: CV

      - name: Push PDF to GitHub
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add CV/github_stars/*.tex 
          git add CV/cv_ryota_maeda.pdf
          if git commit -m "Update CV"; then
            git push
          else
            echo "No changes in GitHub stars"
            git status
          fi
